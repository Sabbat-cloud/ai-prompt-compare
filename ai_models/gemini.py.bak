# ai_models/gemini.py
import os
import google.generativeai as genai
from .base_model import AIModel, logger

class GeminiModel(AIModel):
    """
    Conector para la API de Google Gemini, adaptado a la nueva clase base.
    """

    def _validate_config(self):
        """Valida la configuración específica de Gemini."""
        super()._validate_config()
        if 'api_key_env' not in self.config or 'model_name_api' not in self.config:
            raise ValueError("La configuración de Gemini debe contener 'api_key_env' y 'model_name_api'.")

    def _initialize_model(self):
        """Configura el modelo Gemini usando la API key del entorno."""
        api_key_env_var = self.config['api_key_env']
        api_key = os.getenv(api_key_env_var)

        if not api_key:
            raise ValueError(f"La variable de entorno '{api_key_env_var}' no está configurada.")
        
        genai.configure(api_key=api_key)
        self.model = genai.GenerativeModel(self.config['model_name_api'])

    def query(self, prompt: str) -> str:
        """
        Envía un prompt a la API de Gemini y devuelve la respuesta.
        """
        super().query(prompt) # Llama al método base para validaciones y logging
        if self.initialization_error:
            return self.initialization_error
            
        try:
            response = self.model.generate_content(prompt)
            logger.info(f"Respuesta recibida de {self.name}.")
            return response.text
        except Exception as e:
            error_message = f"Error al consultar la API de Gemini ({self.name}): {str(e)}"
            logger.error(error_message)
            return error_message
